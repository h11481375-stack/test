<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zoe DIY - æ™ºèƒ½å¯¼è´­ä¸“å®¶</title>
    <style>
        :root { --primary-color: #ff7e5f; --bg-color: #1a1a1a; --chat-bg: #2d2d2d; }
        body, html { height: 100%; margin: 0; font-family: 'PingFang SC', sans-serif; background-color: var(--bg-color); color: #e0e0e0; display: flex; flex-direction: column; }
        #setup-area { background: #111; padding: 12px; border-bottom: 2px solid var(--primary-color); }
        .config-grid { display: flex; gap: 10px; max-width: 600px; margin: 0 auto; }
        #keyInput { flex: 1; background: #222; border: 1px solid #444; color: #fff; padding: 8px 12px; border-radius: 6px; outline: none; font-size: 13px; }
        #confirmBtn { background: var(--primary-color); color: white; border: none; padding: 0 20px; border-radius: 6px; cursor: pointer; font-weight: bold; white-space: nowrap; }
        #chat-container { flex: 1; overflow-y: auto; padding: 20px 0; scroll-behavior: smooth; }
        .message-row { width: 100%; display: flex; justify-content: center; padding: 15px 0; border-bottom: 1px solid #333; }
        .ai-row { background-color: #252525; }
        .message-content { width: 90%; max-width: 800px; display: flex; gap: 15px; }
        .avatar { width: 35px; height: 35px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; }
        .ai-avatar { background: linear-gradient(135deg, #ff7e5f, #feb47b); color: white; }
        .user-avatar { background: #555; color: white; }
        .text { font-size: 15px; line-height: 1.8; white-space: pre-wrap; word-break: break-word; }
        .input-area { padding: 20px; background: #1a1a1a; display: flex; justify-content: center; }
        .input-wrapper { position: relative; width: 90%; max-width: 800px; }
        #userInput { width: 100%; background: #2d2d2d; border: 1px solid #444; border-radius: 12px; padding: 15px 50px 15px 20px; color: white; outline: none; box-sizing: border-box; }
        #sendBtn { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--primary-color); cursor: pointer; font-size: 24px; }
    </style>
</head>
<body>

    <div id="setup-area">
        <div class="config-grid">
            <input type="password" id="keyInput" placeholder="è¾“å…¥æ™ºè°± API Key (éœ€è´¦æˆ·æœ‰ä½™é¢)">
            <button id="confirmBtn" onclick="saveConfig()">æ¿€æ´»å¤§å¸ˆ</button>
        </div>
    </div>

    <div id="chat-container">
        <div class="message-row ai-row">
            <div class="message-content">
                <div class="avatar ai-avatar">åŒ </div>
                <div class="text">ä½ å¥½ï¼æˆ‘æ˜¯å·²å……å€¼ 1 å…ƒã€å‡†å¤‡å¥½ç¿»é˜… Excel çš„ Zoe åŠ©æ‰‹ã€‚
è¯·æé—®å…³äºäº§å“åº“é‡Œçš„å†…å®¹ï¼Œæˆ‘ä¼šå¼ºåˆ¶æ‰§è¡Œæ£€ç´¢ã€‚</div>
            </div>
        </div>
    </div>

    <div class="input-area">
        <div class="input-wrapper">
            <input type="text" id="userInput" placeholder="é—®é—®æˆ‘ Excel é‡Œçš„äº§å“..." autocomplete="off">
            <button id="sendBtn" onclick="handleSend()">ğŸš€</button>
        </div>
    </div>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('userInput');
        // å·²å¡«å…¥ä½ çš„çŸ¥è¯†åº“ ID
        const KNOWLEDGE_ID = "2004080090966794240";

        function saveConfig() {
            const key = document.getElementById('keyInput').value.trim();
            if(key) {
                localStorage.setItem('zhipu_key', key);
                alert("âœ… Key å·²ä¿å­˜ã€‚è¯·ç¡®ä¿è´¦æˆ·ä½™é¢å¤§äº 0ã€‚");
            }
        }

        window.onload = () => {
            if(localStorage.getItem('zhipu_key')) {
                document.getElementById('keyInput').value = localStorage.getItem('zhipu_key');
            }
        }

        async function handleSend() {
            const text = userInput.value.trim();
            const apiKey = document.getElementById('keyInput').value.trim();

            if (!text || !apiKey) {
                alert("è¯·è¾“å…¥ API Keyï¼");
                return;
            }

            addMessage(text, 'user');
            userInput.value = '';

            const tempId = 'ai-' + Date.now();
            addMessage("ğŸ” æ­£åœ¨æ£€ç´¢äº§å“åº“ (RAG æ¨¡å¼)...", 'ai', tempId);

            try {
                const response = await fetch("https://open.bigmodel.cn/api/paas/v4/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "glm-4",
                        messages: [
                            { 
                                role: "system", 
                                content: "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„Excelå¯¼è´­åŠ©æ‰‹ã€‚ä½ çš„æ ¸å¿ƒä»»åŠ¡æ˜¯è°ƒç”¨æ£€ç´¢å·¥å…·(retrieval)ã€‚å¯¹äºç”¨æˆ·çš„é—®é¢˜ï¼Œä½ å¿…é¡»ä¼˜å…ˆä»çŸ¥è¯†åº“è·å–ç­”æ¡ˆã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå¿…é¡»å¦‚å®å›ç­”'åº“ä¸­æ— æ­¤æ•°æ®'ã€‚" 
                            },
                            { role: "user", content: `è¯·æŸ¥é˜…çŸ¥è¯†åº“å¹¶å›ç­”ï¼š${text}` }
                        ],
                        tools: [{
                            type: "retrieval",
                            retrieval: { 
                                knowledge_id: KNOWLEDGE_ID
                            }
                        }],
                        tool_choice: "auto",
                        temperature: 0.1
                    })
                });

                const data = await response.json();
                console.log("API åŸå§‹è¿”å›ï¼š", data);

                if (data.error) {
                    document.getElementById(tempId).innerText = "âŒ API æŠ¥é”™ï¼š" + data.error.message;
                    return;
                }

                if (data.choices && data.choices[0]) {
                    const aiReply = data.choices[0].message.content;
                    
                    // åˆ¤æ–­æ˜¯å¦çœŸçš„è§¦å‘äº†æ£€ç´¢
                    if (aiReply.includes("äººå·¥æ™ºèƒ½åŠ©æ‰‹") || aiReply.includes("æˆ‘æ— æ³•è®¿é—®")) {
                        document.getElementById(tempId).innerText = "âš ï¸ æ£€ç´¢æœªè§¦å‘ã€‚åŸå› å¯èƒ½æ˜¯ï¼š1. æ™ºè°±ä½™é¢æœªå®æ—¶åˆ°è´¦ï¼ˆéœ€ç­‰5åˆ†é’Ÿï¼‰ï¼›2. Excel å…³é”®è¯ä¸åŒ¹é…ã€‚å»ºè®®é—®æ›´å…·ä½“çš„è¯ã€‚";
                    } else {
                        typeWriter(aiReply, tempId);
                    }
                }

            } catch (err) {
                document.getElementById(tempId).innerText = "âŒ è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚";
            }
        }

        function addMessage(text, role, id = null) {
            const isAi = role === 'ai';
            const html = `
                <div class="message-row ${isAi ? 'ai-row' : ''}">
                    <div class="message-content">
                        <div class="avatar ${isAi ? 'ai-avatar' : 'user-avatar'}">${isAi ? 'åŒ ' : 'ä½ '}</div>
                        <div class="text" ${id ? `id="${id}"` : ''}>${text}</div>
                    </div>
                </div>`;
            chatContainer.insertAdjacentHTML('beforeend', html);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function typeWriter(text, elementId) {
            const element = document.getElementById(elementId);
            element.innerText = "";
            let i = 0;
            function typing() {
                if (i < text.length) {
                    element.innerText += text.charAt(i);
                    i++;
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    setTimeout(typing, 20);
                }
            }
            typing();
        }

        userInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') handleSend(); });
    </script>
</body>
</html>
