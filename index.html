<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zoe DIY - æ™ºèƒ½å¯¼è´­ä¸“å®¶</title>
    <style>
        :root { --primary-color: #ff7e5f; --bg-color: #1a1a1a; --chat-bg: #2d2d2d; }
        body, html { height: 100%; margin: 0; font-family: 'PingFang SC', sans-serif; background-color: var(--bg-color); color: #e0e0e0; display: flex; flex-direction: column; }
        
        /* é¡¶éƒ¨é…ç½®åŒº */
        #setup-area { background: #111; padding: 12px; border-bottom: 2px solid var(--primary-color); }
        .config-grid { display: flex; gap: 10px; max-width: 600px; margin: 0 auto; }
        #keyInput { flex: 1; background: #222; border: 1px solid #444; color: #fff; padding: 8px 12px; border-radius: 6px; outline: none; font-size: 13px; }
        #confirmBtn { background: var(--primary-color); color: white; border: none; padding: 0 20px; border-radius: 6px; cursor: pointer; font-weight: bold; white-space: nowrap; }

        /* èŠå¤©åŒº */
        #chat-container { flex: 1; overflow-y: auto; padding: 20px 0; scroll-behavior: smooth; }
        .message-row { width: 100%; display: flex; justify-content: center; padding: 15px 0; border-bottom: 1px solid #333; }
        .ai-row { background-color: #252525; }
        .message-content { width: 90%; max-width: 800px; display: flex; gap: 15px; }
        .avatar { width: 35px; height: 35px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; }
        .ai-avatar { background: linear-gradient(135deg, #ff7e5f, #feb47b); color: white; }
        .user-avatar { background: #555; color: white; }
        .text { font-size: 15px; line-height: 1.8; white-space: pre-wrap; word-break: break-word; }

        /* è¾“å…¥åŒº */
        .input-area { padding: 20px; background: #1a1a1a; display: flex; justify-content: center; }
        .input-wrapper { position: relative; width: 90%; max-width: 800px; }
        #userInput { width: 100%; background: #2d2d2d; border: 1px solid #444; border-radius: 12px; padding: 15px 50px 15px 20px; color: white; outline: none; box-sizing: border-box; }
        #sendBtn { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--primary-color); cursor: pointer; font-size: 24px; }
    </style>
</head>
<body>

    <div id="setup-area">
        <div class="config-grid">
            <input type="password" id="keyInput" placeholder="è¾“å…¥ API Key æ¿€æ´»äº§å“åº“æ£€ç´¢">
            <button id="confirmBtn" onclick="saveConfig()">æ¿€æ´»å¤§å¸ˆ</button>
        </div>
    </div>

    <div id="chat-container">
        <div class="message-row ai-row">
            <div class="message-content">
                <div class="avatar ai-avatar">åŒ </div>
                <div class="text">ä½ å¥½ï¼æˆ‘æ˜¯ Zoe DIY çš„ä¸“ä¸šåŠ©æ‰‹ã€‚
æˆ‘å·²ç»è¿æ¥åˆ°ä½ çš„ Excel äº§å“åº“ã€‚
è¯·è¾“å…¥ Key åï¼Œé—®æˆ‘å…³äºäº§å“ä»·æ ¼ã€è§„æ ¼æˆ–åˆ¶ä½œå»ºè®®çš„é—®é¢˜å§ï¼</div>
            </div>
        </div>
    </div>

    <div class="input-area">
        <div class="input-wrapper">
            <input type="text" id="userInput" placeholder="é—®é—®æˆ‘å…³äºäº§å“æˆ–åˆ¶ä½œæ­¥éª¤..." autocomplete="off">
            <button id="sendBtn" onclick="handleSend()">ğŸš€</button>
        </div>
    </div>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('userInput');
        const KNOWLEDGE_ID = "2004080090966794240";

        function saveConfig() {
            const key = document.getElementById('keyInput').value.trim();
            if(key) {
                localStorage.setItem('zhipu_key', key);
                alert("âœ… API Key å·²ä¿å­˜ï¼Œæ£€ç´¢åŠŸèƒ½å·²å°±ç»ªï¼");
            }
        }

        window.onload = () => {
            if(localStorage.getItem('zhipu_key')) {
                document.getElementById('keyInput').value = localStorage.getItem('zhipu_key');
            }
        }

        async function handleSend() {
            const text = userInput.value.trim();
            const apiKey = document.getElementById('keyInput').value.trim();

            if (!text || !apiKey) {
                alert("è¯·è¾“å…¥ API Keyï¼");
                return;
            }

            addMessage(text, 'user');
            userInput.value = '';

            const tempId = 'ai-' + Date.now();
            addMessage("ğŸ” æ­£åœ¨æ£€ç´¢äº§å“åº“...", 'ai', tempId);

            try {
                const response = await fetch("https://open.bigmodel.cn/api/paas/v4/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "glm-4",
                        messages: [
                            { 
                                role: "system", 
                                content: "ä½ æ˜¯ä¸€ä½ä¸“ä¸šDIYå¤§å¸ˆï¼Œå¿…é¡»æ ¹æ®æä¾›çš„æ£€ç´¢å†…å®¹ï¼ˆretrievalï¼‰æ¥å›ç­”äº§å“ä»·æ ¼å’Œæè¿°ã€‚å¦‚æœçŸ¥è¯†åº“ä¸­æœ‰ä¿¡æ¯ï¼Œè¯·è¯¦ç»†åˆ—å‡ºï¼›å¦‚æœæ‰¾ä¸åˆ°ï¼Œè¯·ç»“åˆä¸“ä¸šDIYå¸¸è¯†å›ç­”ï¼Œå¹¶æé†’ç”¨æˆ·ç›¸å…³äº§å“å¯èƒ½ä¸åœ¨åº“ä¸­ã€‚" 
                            },
                            { role: "user", content: text }
                        ],
                        tools: [{
                            type: "retrieval",
                            retrieval: { 
                                knowledge_id: KNOWLEDGE_ID 
                            }
                        }],
                        tool_choice: "auto",
                        temperature: 0.1
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    document.getElementById(tempId).innerText = "API æŠ¥é”™: " + data.error.message;
                    return;
                }

                if (data.choices && data.choices[0]) {
                    const aiReply = data.choices[0].message.content;
                    typeWriter(aiReply, tempId);
                } else {
                    document.getElementById(tempId).innerText = "æ£€ç´¢æœªè¿”å›å†…å®¹ï¼Œè¯·æ£€æŸ¥çŸ¥è¯†åº“çŠ¶æ€ã€‚";
                }

            } catch (err) {
                document.getElementById(tempId).innerText = "è¿æ¥å¤±è´¥ï¼Œè¯·ç¡®è®¤ç½‘ç»œæ˜¯å¦æ­£å¸¸ã€‚";
            }
        }

        function addMessage(text, role, id = null) {
            const isAi = role === 'ai';
            const html = `
                <div class="message-row ${isAi ? 'ai-row' : ''}">
                    <div class="message-content">
                        <div class="avatar ${isAi ? 'ai-avatar' : 'user-avatar'}">${isAi ? 'åŒ ' : 'ä½ '}</div>
                        <div class="text" ${id ? `id="${id}"` : ''}>${text}</div>
                    </div>
                </div>`;
            chatContainer.insertAdjacentHTML('beforeend', html);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function typeWriter(text, elementId) {
            const element = document.getElementById(elementId);
            element.innerText = "";
            let i = 0;
            function typing() {
                if (i < text.length) {
                    element.innerText += text.charAt(i);
                    i++;
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    setTimeout(typing, 20);
                }
            }
            typing();
        }

        userInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') handleSend(); });
    </script>
</body>
</html>
