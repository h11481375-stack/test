<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zoe DIY Studio | Excel å¯¼å…¥ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --pink: #ffafbd; --deep-pink: #ff8e9a; --bg: #ffffff; }
        body, html { height: 100%; margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); color: #4a4a4a; }
        #main-container { display: flex; flex-direction: column; height: 100vh; max-width: 800px; margin: 0 auto; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        
        header { padding: 15px; text-align: center; border-bottom: 1px solid #fdf2f4; cursor: pointer; background: #fff; }
        header h1 { margin: 0; font-size: 1.2rem; color: var(--deep-pink); letter-spacing: 2px; }
        #status-bar { font-size: 10px; color: #bbb; margin-top: 5px; }

        /* é…ç½®å¼¹çª— */
        #config-panel { display: none; position: fixed; top: 10%; left: 50%; transform: translateX(-50%); width: 90%; max-width: 500px; background: #fff; box-shadow: 0 10px 40px rgba(0,0,0,0.2); border-radius: 20px; padding: 25px; z-index: 100; border: 1px solid #eee; }
        .config-item { margin-bottom: 15px; }
        input[type="password"], input[type="text"] { width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 10px; box-sizing: border-box; }
        
        /* æ–‡ä»¶ä¸Šä¼ æ ·å¼ */
        .file-upload-area { border: 2px dashed var(--pink); border-radius: 15px; padding: 20px; text-align: center; cursor: pointer; background: #fff9fa; transition: 0.3s; }
        .file-upload-area:hover { background: #ffeef0; }

        #chat-box { flex: 1; overflow-y: auto; padding: 20px; background: #fff; }
        .row { display: flex; margin-bottom: 15px; }
        .user-row { justify-content: flex-end; }
        .bubble { max-width: 80%; padding: 12px 18px; border-radius: 20px; font-size: 14px; line-height: 1.6; }
        .user-bubble { background: #ffe4e8; color: #d63384; border-bottom-right-radius: 5px; }
        .ai-bubble { background: #f8f8f8; border: 1px solid #eee; border-bottom-left-radius: 5px; }

        .input-area { padding: 15px; border-top: 1px solid #f8f8f8; display: flex; gap: 10px; background: #fff; }
        #userInput { flex: 1; border: 2px solid #ffe4e8; border-radius: 30px; padding: 12px 20px; outline: none; }
        .send-btn { background: var(--pink); color: white; border: none; width: 48px; height: 48px; border-radius: 50%; cursor: pointer; font-size: 20px; }
    </style>
</head>
<body>

<div id="main-container">
    <header onclick="toggleConfig()">
        <h1>ZOE DIY STUDIO ğŸŒ¸</h1>
        <div id="status-bar">ç‚¹å‡»å¯¼å…¥ Excel æ•°æ®å¹¶é…ç½® Key</div>
    </header>

    <div id="chat-box">
        <div class="row"><div class="bubble ai-bubble">æ¬¢è¿å›æ¥ï¼è¯·å…ˆä¸Šä¼ ä½ çš„ Excel åº“å­˜è¡¨ï¼ŒZoe å°±èƒ½å¸®ä½ çœ‹ç€åº—å•¦ï¼âœ¨</div></div>
    </div>

    <div id="config-panel">
        <h3 style="color:var(--deep-pink); margin: 0 0 20px 0;">ç³»ç»Ÿé…ç½®</h3>
        
        <div class="config-item">
            <label style="font-size: 12px; color: #888;">æ™ºè°± API Key:</label>
            <input type="password" id="apiKey" placeholder="ç²˜è´´ä½ çš„ API Key">
        </div>

        <div class="config-item">
            <label style="font-size: 12px; color: #888;">åº“å­˜æ–‡ä»¶ (Excel æˆ– CSV):</label>
            <div class="file-upload-area" onclick="document.getElementById('fileInput').click()">
                <span id="file-name">ç‚¹å‡»ä¸Šä¼ æ–‡ä»¶</span>
                <input type="file" id="fileInput" hidden accept=".xlsx, .xls, .csv" onchange="handleFile(this)">
            </div>
        </div>

        <button onclick="saveAndClose()" style="width:100%; background:var(--deep-pink); color:white; border:none; padding:15px; border-radius:30px; cursor:pointer; font-weight: bold;">ä¿å­˜å¹¶å¼€å§‹å·¥ä½œ</button>
        <button onclick="toggleConfig()" style="width:100%; background:none; border:none; color:#bbb; margin-top:10px; cursor:pointer;">è¿”å›</button>
    </div>

    <div class="input-area">
        <input type="text" id="userInput" placeholder="è¾“å…¥åç§°æˆ– SKU æŸ¥è¯¢..." onkeypress="if(event.keyCode==13) handleSend()">
        <button class="send-btn" onclick="handleSend()">ğŸ’–</button>
    </div>
</div>

<script>
    let tempDatabase = "";

    // é¡µé¢å¯åŠ¨åŠ è½½
    window.onload = () => {
        const db = localStorage.getItem('zoe_database');
        if(db) {
            updateStatus(`âœ… å·²åŠ è½½æœ¬åœ°æ•°æ®ï¼Œéšæ—¶å¯æŸ¥`);
        }
    };

    function toggleConfig() {
        const p = document.getElementById('config-panel');
        p.style.display = p.style.display === 'block' ? 'none' : 'block';
        document.getElementById('apiKey').value = localStorage.getItem('zhipu_key') || '';
    }

    // å¤„ç†æ–‡ä»¶å¯¼å…¥
    function handleFile(input) {
        const file = input.files[0];
        if (!file) return;
        document.getElementById('file-name').innerText = "è¯»å–ä¸­: " + file.name;

        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            // è½¬åŒ–ä¸º CSV æ–‡æœ¬ï¼ŒAI æœ€å®¹æ˜“ç†è§£è¿™ç§æ ¼å¼
            tempDatabase = XLSX.utils.sheet_to_csv(firstSheet);
            document.getElementById('file-name').innerText = "âœ… å·²è¯»å–: " + file.name;
        };
        reader.readAsArrayBuffer(file);
    }

    function saveAndClose() {
        const key = document.getElementById('apiKey').value;
        if(key) localStorage.setItem('zhipu_key', key);
        if(tempDatabase) localStorage.setItem('zoe_database', tempDatabase);
        
        alert("é…ç½®æˆåŠŸï¼Zoe å·²å°±ç»ªã€‚ğŸŒ¸");
        toggleConfig();
        location.reload();
    }

    async function handleSend() {
        const input = document.getElementById('userInput');
        const text = input.value.trim();
        const apiKey = localStorage.getItem('zhipu_key');
        const database = localStorage.getItem('zoe_database');

        if(!apiKey) { alert("è¯·å…ˆé…ç½® API Keyï¼"); toggleConfig(); return; }
        if(!database) { alert("è¯·å…ˆå¯¼å…¥ Excel æ–‡ä»¶ï¼"); toggleConfig(); return; }
        if(!text) return;

        addMsg(text, 'user');
        input.value = '';
        const aiBubble = addMsg("Zoe æ­£åœ¨æ ¸å¯¹åº“å­˜è¡¨...", 'ai');

        try {
            const response = await fetch("https://open.bigmodel.cn/api/paas/v4/chat/completions", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                body: JSON.stringify({
                    model: "glm-4",
                    messages: [
                        { role: "system", content: `ä½ æ˜¯DIYç®¡å®¶Zoeã€‚è¿™æ˜¯åº“å­˜æ•°æ®(CSVæ ¼å¼)ï¼š\n${database.substring(0, 50000)}\nè¯·æ ¹æ®æ­¤æ•°æ®æŸ¥SKUã€ä»“ä½ã€‚å¦‚æœæ•°æ®é‡å¤§ï¼Œåªéœ€å›ç­”æœ€ç›¸å…³çš„ç»“æœã€‚è¯­è°ƒç”œç¾äº²åˆ‡ã€‚` },
                        { role: "user", content: text }
                    ]
                })
            });
            const data = await response.json();
            const reply = data.choices[0].message.content;
            aiBubble.innerText = reply;
            
            const msg = new SpeechSynthesisUtterance(reply);
            msg.pitch = 1.35;
            window.speechSynthesis.speak(msg);
        } catch (e) { aiBubble.innerText = "å‡ºé”™äº†ï¼Œå¯èƒ½æ˜¯ API Key çš„é—®é¢˜å–”ã€‚"; }
    }

    function addMsg(text, role) {
        const row = document.createElement('div');
        row.className = `row ${role}-row`;
        row.innerHTML = `<div class="bubble ${role}-bubble">${text}</div>`;
        const box = document.getElementById('chat-box');
        box.appendChild(row);
        box.scrollTop = box.scrollHeight;
        return row.lastChild;
    }

    function updateStatus(msg) {
        document.getElementById('status-bar').innerText = msg;
    }
</script>
</body>
</html>
